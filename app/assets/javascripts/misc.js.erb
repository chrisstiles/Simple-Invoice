Turbolinks.enableProgressBar();

var ready;
ready = function() {

var pageBody = $('body');

// Show loading animation after user clicks generate PDF, while the PDF loads (on index page)

pageBody.on('click', '.thirdbutton.file', function() {
	$(this).siblings('.homeinvoiceloader').fadeIn(200);
});

// Remove success modal when close is clicked
pageBody.on('click', '.closesuccess', function() {
	$(this).parent('.success').remove();
});

pageBody.on('click', '.homerecordpayment', function() {
	pageBody.addClass('homerecordclicked');
});

// Remove error class when input changes
var compareVal;

pageBody.on('keydown', '.haserror', function() {
	var $this = $(this);
	compareVal = $this.val();
});

pageBody.on('keyup', '.haserror', function() {
	var $this = $(this);
	var newVal = $this.val();

	if (compareVal != newVal) {
		$this.removeClass('haserror');
	}

	$this.parents('.selectize-input').removeClass('haserror');

});

// Close validation errors on close button
pageBody.on('click', '.closeerrors', function() {
	var $this = $(this);
	var parentEl;
	if ($this.parents('#validationerrors').length) {
		parentEl = $this.parents('#validationerrors');
	} else {
		parentEl = $this.parents('#modalvalidaitonerrors');
		parentEl.parents('#modalcontent').scrollTop(0);
	}
	
	parentEl.removeAttr('style').removeClass('hastransformed').hide();
	if (!pageBody.hasClass('show')) {
		$('#invoicewrapper').removeAttr('style');
		$('.formholder').removeAttr('style');
	}
});

// Ajax call to delete invoice when button is pressed
pageBody.on('click', '.deleteinvoice', function() {
	var invoiceNumber = $(this).attr('data-invoicenumber');
	var confirmation = confirm('Are you sure you would like to delete this invoice?')

	if(confirmation) {
	    $.ajax({
	        type: 'delete',
	        url: '/invoices/' + invoiceNumber,
	        dataType: 'script',
	        async: true
	        }).done(function( msg ) {

		  	}).fail(function(msg){
		   	 console.log(msg)
		  });
	}

});

// Set position of home page sidebar
var homePageWrapper = $('#pagewrapper');
var homeSide = $('#homeside');

function setSidebarPosition() {
	
	var leftPosition = homePageWrapper.offset().left + homePageWrapper.outerWidth();
	homeSide.css('left', leftPosition);

}

if (homePageWrapper.length) {
	setSidebarPosition();
}

// Set position of pagination if it exists
var searchResults = $('#searchresults');

function setHomePagination() {
	var pagination = $('#homepagination');
	var homeInvoice = $('.homeinvoice');
	if (homeInvoice.length) {
		var leftPosition = homeInvoice.first().offset().left - 100;
		
		var rightPosition = $(window).width() - homeSide.offset().left;

		pagination.css({
			'left' : leftPosition,
			'right' : rightPosition
		});

		
		if ($('.pagination').length) {
			pagination.show();
			searchResults.css('padding-top', '70px');
		} else {
			searchResults.css('padding-top', '0');
			pagination.hide();
		}

	}
}

if (homePageWrapper.length) {
	setHomePagination();
}


// Show home page amount paid form

pageBody.on('click', '.pig', function(e) {
	e.preventDefault();
	var $this = $(this);
	$this.siblings('.homeinvoiceinfowrapper').children().addClass('active');
	$this.addClass('homeclose');
	$this.find('span').text('Cancel Recording Payment');
});

pageBody.on('click', '.homeclose', function(e) {
	var $this = $(this);
	$this.removeClass('homeclose');
	$this.siblings('.homeinvoiceinfowrapper').children().removeClass('active');
	$this.find('span').text('Record Payment');
});




// Focus amount paid box when row is clicked

pageBody.on('click', '.amountpaidrow', function() {
	$(this).find('span').focus();
});

var amountPaid = $('.e-amountpaid');

pageBody.on('focus', '.e-amountpaid', function() {
	$(this).closest('.row').addClass('active');
});

pageBody.on('blur', '.e-amountpaid', function() {
	$(this).closest('.row').removeClass('active');
});

// Prevent amount paid entered from being higher than invoice total

pageBody.on('keyup', '.e-amountpaid', function(e) {
	
	var $this = $(this);
	var amountPaid = parseFloat($this.text(), 10);
	var parentRow = $this.parents('.row');
	var invoiceTotalCell = parentRow.siblings('.invoicetotalrow').find('.invoicetotalcell');
	var invoiceBalanceCell = parentRow.siblings('.balancerow').find('.balancecell');
	var invoiceTotal =  parseFloat(Number( invoiceTotalCell.text().replace(/[^0-9\.]+/g,"")), 10);

	if (amountPaid > invoiceTotal) {
		$this.addClass('toomuch');
	} else {
		$this.removeClass('toomuch');
		$this.siblings('.homeamountpaiderror').hide();
	}

	var invoiceBalance = invoiceTotal - amountPaid;

	if (isNaN(invoiceBalance)) {
		invoiceBalanceCell.text('$' + invoiceTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
	} else {
		invoiceBalanceCell.text('$' + invoiceBalance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
	}

});


// Alert the user if the logo they upload is too big
$('#user_logo').bind('change', function() {
	var size_in_megabytes = this.files[0].size/1024/1024;
		if (size_in_megabytes > 5) {
	  		alert('Maximum file size is 5MB. Please choose a smaller file.');
		}
});


// Changed fixed positions on window resize
$( window ).resize(function() {
	if (homePageWrapper.length) {
		setSidebarPosition();
		if ($('.homeinvoice').length) {
			setHomePagination();
		}
	}
});


// Fix Dropzone
// disable auto discover
Dropzone.autoDiscover = false;

// grap our upload form by its id
$(".logouploader").dropzone({
	// restrict image size to a maximum 1MB
	maxFilesize: 1,
	dictDefaultMessage: "Drop your logo here to upload",
	// changed the passed param to one accepted by
	// our rails app
	paramName: "logo[image]",
	// show remove links on each image upload
	addRemoveLinks: true
});	


};

$(document).ready(ready);
$(document).on('page:load', ready);